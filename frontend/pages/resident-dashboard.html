<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resident Portal | HMS Hub</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --secondary: #3b82f6; }
        .sidebar { background: #1e3a8a; }
        .status-unpaid { background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-paid { background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        
        /* ðŸ”¥ Notification Bell Styling */
        #notifBadge { background: #ef4444; color: white; border-radius: 50%; padding: 2px 7px; font-size: 11px; margin-left: 5px; display: none; }
        .bell-icon { position: relative; cursor: pointer; margin-right: 20px; }
        .bell-dot { position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 2px solid #1a1f3c; display: none; }

        .notif-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; }
        .notif-modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; position: relative; color: #333; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active-tab { display: block; }

        .charts-row { display: flex; gap: 20px; margin-top: 25px; }
        .chart-container { flex: 1; background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); min-height: 300px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><h2>HMS<span>User</span></h2></div>
            <nav>
                <ul>
                    <li id="nav-dash" class="active" onclick="showTab('dashboard-tab', this)" style="cursor: pointer;">My Dashboard</li>
                    <li onclick="showTab('bills-tab', this)" style="cursor: pointer;">My Bills</li>
                    <li onclick="location.href='user-complaints.html'" style="cursor: pointer;">Complaints</li>
                    <li onclick="showTab('visitors-tab', this); clearVisitorBadge();" style="cursor: pointer;">
                        My Visitors <span id="visitorBadge" style="background: #10b981; color: white; border-radius: 50%; padding: 2px 7px; font-size: 11px; display: none;">0</span>
                    </li>
                    <li onclick="showTab('notif-tab', this); clearBadge();" style="cursor: pointer;">
                        Notifications <span id="notifBadge">0</span>
                    </li>
                    <li onclick="logoutUser()" style="cursor: pointer; margin-top: 20px; color: #fda4af;">Logout</li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="welcomeText">Welcome, Resident</h1>
                    <p id="userHouse">House No: Loading...</p>
                </div>
                <div class="bell-icon" onclick="showTab('visitors-tab', document.querySelector('li[onclick*=\'visitors-tab\']')); clearVisitorBadge();">
                    <i class="fa fa-bell" style="font-size: 24px; color: #fff;"></i>
                    <span class="bell-dot" id="headerNotifDot"></span>
                </div>
            </header>

            <div id="dashboard-tab" class="tab-content active-tab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Pending Amount</h3>
                        <p class="value" id="pendingAmount">Rs. 0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Bills</h3>
                        <p class="value" id="totalBillsCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>My Complaints</h3>
                        <p class="value" id="myComplaintsCount">0</p>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-container">
                        <canvas id="userBillsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="userCompChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="notif-tab" class="tab-content">
                <section id="notificationsSection" class="recent-section">
                    <h2>ðŸ“¢ Announcements</h2>
                    <div id="notificationsContainer" style="display: grid; gap: 10px; margin-top: 15px;">
                        <p style="color: #888; padding: 10px;">Checking for new updates...</p>
                    </div>
                </section>
            </div>

            <div id="visitors-tab" class="tab-content">
                <section class="recent-section">
                    <h2><i class="fa fa-user-shield"></i> Recent Visitors at My House</h2>
                    <p style="color: #888; font-size: 13px; margin-bottom: 20px;">Real-time logs from the main gate.</p>
                    <div class="table-container">
                        <table id="userVisitorsTable">
                            <thead>
                                <tr>
                                    <th>Visitor Name</th>
                                    <th>Purpose</th>
                                    <th>Entry Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="userVisitorsBody">
                                <tr><td colspan="4" style="text-align:center">No visitors recorded yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="bills-tab" class="tab-content">
                <section id="recentBillsSection" class="recent-section">
                    <h2>My Full Billing History</h2>
                    <div class="table-container">
                        <table id="userBillsTable">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="notifOpenModal" class="notif-modal">
        <div class="notif-modal-content">
            <span onclick="closeNotifModal()" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px;">&times;</span>
            <h2 id="modalNotifTitle" style="color: #2563eb; margin-bottom: 10px;"></h2>
            <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 15px;">
            <p id="modalNotifMsg" style="line-height: 1.6; font-size: 15px;"></p>
            <p id="modalNotifDate" style="margin-top: 20px; font-size: 12px; color: #888;"></p>
        </div>
    </div>

    <script>
        function showTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active-tab');
            });
            document.getElementById(tabId).classList.add('active-tab');
            document.querySelectorAll('.sidebar ul li').forEach(li => {
                li.classList.remove('active');
            });
            element.classList.add('active');
        }

        function closeNotifModal() {
            document.getElementById("notifOpenModal").style.display = "none";
        }

        function clearBadge() {
            const badge = document.getElementById("notifBadge");
            if (badge) badge.style.display = "none";
        }

        // ðŸ”¥ Naya: Visitor badge aur dot clear karne ka function
        function clearVisitorBadge() {
            document.getElementById("visitorBadge").style.display = "none";
            document.getElementById("headerNotifDot").style.display = "none";
        }

        // ðŸ”¥ Real-time Visitor Notification Logic
        let lastVisitorCount = 0;

        async function checkVisitors() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) return;

            try {
                const res = await fetch(`http://localhost:5000/visitors-log`);
                const allVisitors = await res.json();
                
                // Filter visitors for this specific house
                const myVisitors = allVisitors.filter(v => v.house_no === user.house_no);
                const tableBody = document.getElementById("userVisitorsBody");
                
                if (tableBody) {
                    tableBody.innerHTML = "";
                    if (myVisitors.length === 0) {
                        tableBody.innerHTML = "<tr><td colspan='4' style='text-align:center'>No visitors recorded yet.</td></tr>";
                    } else {
                        myVisitors.forEach(v => {
                            const time = new Date(v.entry_time).toLocaleString('en-PK', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'});
                            tableBody.innerHTML += `
                                <tr>
                                    <td><b>${v.visitor_name}</b></td>
                                    <td>${v.purpose}</td>
                                    <td>${time}</td>
                                    <td><span style="color:#10b981"><i class="fa fa-check-circle"></i> Entered</span></td>
                                </tr>
                            `;
                        });
                    }
                }

                // Check for new visitors to show notification
                if (myVisitors.length > lastVisitorCount && lastVisitorCount !== 0) {
                    const diff = myVisitors.length - lastVisitorCount;
                    document.getElementById("visitorBadge").innerText = diff;
                    document.getElementById("visitorBadge").style.display = "inline-block";
                    document.getElementById("headerNotifDot").style.display = "block";
                    
                    // Optional: Play a small notification sound
                    // new Audio('../assets/notif.mp3').play();
                }
                lastVisitorCount = myVisitors.length;

            } catch (err) {
                console.error("Visitor fetch error:", err);
            }
        }

        // Har 10 seconds mein auto-refresh
        setInterval(checkVisitors, 10000);
        window.addEventListener('DOMContentLoaded', checkVisitors);
        
    </script>
    <script src="../js/resident-logic.js"></script>
</body>
</html>